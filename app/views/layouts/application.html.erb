<!DOCTYPE html>
<html>
  <head>
    <title id="timerTitle">Simple Pomodoro Timer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
    
    
    <!-- fontawesome -->
    <script src="https://kit.fontawesome.com/48e9ba994a.js" crossorigin="anonymous"></script>
  </head>

  <body>
    <main class="main-content">
      <div class="content-wrapper">
        <%= yield %>
      </div>
    </main> 
    <footer class="footer">
      <p class="footer-text">&copy; <%= Time.now.year %> Sugachan</p>
    </footer>    
  </body>
</html>

<script>
  // let workTime = 25 * 60 * 1000;
// let restTime = 5 * 60 * 1000;
// let longRestTime = 15 * 60 * 1000;
let workTime = 25 * 60 * 1000;
let restTime = 5 * 60 * 1000;
let longRestTime = 15 * 60 * 1000;

let intervalCount = 2;
let numberWorkIntervals = intervalCount;
let currentMode = "Work";
let time = workTime;


let interval;

const timer = document.getElementById('timer');
const timerTitle = document.getElementById('timerTitle');
// const timerTitle = "Simple Pomodoro Timer XX"; //check later
const dataPercent = document.querySelectorAll('.data-percent');
const modeEl = document.getElementById('mode');

updateCountdown(time);
// countdown(time); 削除
timerTitle.innerText = "Simple Pomodoro Timer"; //追加

function countdown(pTime) {
  interval = setInterval(() => {
    pTime -= 1000;
    // time = pTime;
    if (pTime <= 0) {
      clearInterval(interval);
      numberWorkIntervals = currentMode == "Work" ? numberWorkIntervals - 1 : numberWorkIntervals;
      // if (numberWorkIntervals > 0) {
      //   swapMode();
      // }
      swapMode();
    }

    updateCountdown(pTime);

  }, 1000)
}


// function swapMode() {
//   currentMode = currentMode == "Work" ? "Rest" : "Work";
//   time = currentMode == "Work" ? workTime : restTime;

//   updateCountdown(time);
//   countdown(time);
// }

function swapMode() {
  if (currentMode == "Work") {
    if (numberWorkIntervals == 0) {
      currentMode = "LongRest";
      time = longRestTime;

    } else {
      currentMode = "Rest";
      time = restTime;
    }
  } else if (currentMode == "Rest") {
    currentMode = "Work";
    time = workTime;
  } else if (currentMode == "LongRest") {
    currentMode = "Work";
    time = workTime;
    numberWorkIntervals = intervalCount;
  }

  updateCountdown(time);
  countdown(time);
}

// function swapMode() {
//   if (numberWorkIntervals <= 0) {
//     currentMode = "Work"; // ワーク間隔がすべて終了した場合は再度"Work"モードに戻る
//     numberWorkIntervals = intervalCount;
//     time = workTime;
//   } else {
//     currentMode = currentMode == "Work" ? "Rest" : "Work";
//     numberWorkIntervals = currentMode == "Work" ? numberWorkIntervals : numberWorkIntervals - 1;
//     time = currentMode == "Work" ? workTime : restTime;
//   }

//   updateCountdown(time);
//   countdown(time);
// }

function updateCountdown(pTime) {

  // if (numberWorkIntervals <= 0) {
  //   dataPercent[0].style.setProperty('--angle', '360deg');
  //   // dataPercent[0].style.setProperty('--color', 'red');
  //   dataPercent[0].style.setProperty('--color', 'yellow');
  //   timer.innerText = "00:00";
  //   modeEl.innerText = "END";
  // }

  if (pTime <= 0) {
    dataPercent[0].style.setProperty('--angle', '360deg');
    // dataPercent[0].style.setProperty('--color', 'red');
    // timer.innerText = "00:00";
  } else {
    // let color = currentMode == "Work" ? "blue" : "red";
    // let angle = (pTime / (currentMode == "Work" ? workTime : restTime) * 360) + 'deg';
    let color;
    let angle;

    if (currentMode == "Work") {
      color = "blue";
      angle = (pTime / workTime * 360) + 'deg';
    } else if (currentMode == "Rest") {
      color = "red";
      angle = (pTime / restTime * 360) + 'deg';
    } else {
      color = "yellow";
      angle = (pTime / longRestTime * 360) + 'deg';
    }

    dataPercent[0].style.setProperty('--angle', angle);
    dataPercent[0].style.setProperty('--color', color);

    let minutes = Math.floor(pTime / 60 / 1000).toString().padStart(2, "0");
    let seconds = ((pTime / 1000) % 60).toString().padStart(2, "0")
    timer.innerText = minutes + ":" + seconds;
    timerTitle.innerText = timer.innerText; //追加
    modeEl.innerText = currentMode + ` ${numberWorkIntervals}`;
  }
}

function play() {
  clearInterval(interval);
  countdown(time);
  document.getElementsByClassName('pause')[0].classList.remove('d-none');
  document.getElementsByClassName('play')[0].classList.add('d-none');
}

function pause() {
  clearInterval(interval);
  console.log(numberWorkIntervals);
  let [minutes, seconds] = timer.innerText.split(":");
  time = ((minutes * 60) + seconds * 1) * 1000;
  document.getElementsByClassName('play')[0].classList.remove('d-none');
  document.getElementsByClassName('pause')[0].classList.add('d-none');
}

// function reset() {
//   currentMode = "Work";
//   numberWorkIntervals = intervalCount;
//   time = workTime;

//   document.getElementsByClassName('pause')[0].classList.remove('d-none');
//   document.getElementsByClassName('play')[0].classList.add('d-none');

//   clearInterval(interval);
//   updateCountdown(time);
//   countdown(time);
// }

function stop() {
  currentMode = "Work";
  numberWorkIntervals = intervalCount;
  time = workTime;
  document.getElementsByClassName('pause')[0].classList.add('d-none');
  document.getElementsByClassName('play')[0].classList.remove('d-none');
  clearInterval(interval);
  updateCountdown(time);
}

function applyNewTimes() {
  let workTimeInputMinutes = document.getElementById('work-time-minutes').value;
  let workTimeInputSeconds = document.getElementById('work-time-seconds').value;
  let workIntervalInputs = document.getElementById('work-time-intervals').value;
  let restTimeInputMinutes = document.getElementById('rest-time-minutes').value;
  let restTimeInputSeconds = document.getElementById('rest-time-seconds').value;
  let longRestTimeInputMinutes = document.getElementById('long-rest-time-minutes').value;
  let longRTimeInputSeconds = document.getElementById('long-rest-time-seconds').value;

  workTime = workTimeInputMinutes * 60 * 1000 + workTimeInputSeconds * 1000;
  restTime = restTimeInputMinutes * 60 * 1000 + restTimeInputSeconds * 1000;
  longRestTime = longRestTimeInputMinutes * 60 * 1000 + longRTimeInputSeconds * 1000;

  intervalCount = workIntervalInputs;

  numberWorkIntervals = intervalCount;
  currentMode = "Work";
  time = workTime;

  console.log(workTime, restTime, intervalCount)

  clearInterval(interval);
  updateCountdown(time);
  // countdown(time);
}

function closeSettings() {
  let settingsList = document.querySelectorAll('.settings-list')[0];
  settingsList.style.right = "-20vw";
}

function openSettings() {
  let settingsList = document.querySelectorAll('.settings-list')[0];
  settingsList.style.right = "0";
}

</script>
